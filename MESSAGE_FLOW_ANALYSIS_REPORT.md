# ๐ ุชูุฑูุฑ ุชุญููู ุชุฏูู ุฑุณุงุฆู WhatsApp ูู ูุธุงู ConvGo

## ุชุฏูู ุงูุฑุณุงุฆู ูู ุงูููุจ ููู ุฅูู Redis ูุงููุนุงูุฌุฉ ุฎูุงู ูุงูุฐุฉ 8 ุซูุงูู

---

## ๐ **ุฌุฏูู ุงููุญุชููุงุช**

1. [ูุธุฑุฉ ุนุงูุฉ ุนูู ุงููุธุงู](#ูุธุฑุฉ-ุนุงูุฉ-ุนูู-ุงููุธุงู)
2. [ุงููุฑุญูุฉ ุงูุฃููู: ุงุณุชูุจุงู ุงูุฑุณุงูุฉ ูู ุงูููุจ ููู](#ุงููุฑุญูุฉ-ุงูุฃููู-ุงุณุชูุจุงู-ุงูุฑุณุงูุฉ-ูู-ุงูููุจ-ููู)
3. [ุงููุฑุญูุฉ ุงูุซุงููุฉ: ุฅุถุงูุฉ ุงูุฑุณุงูุฉ ุฅูู Redis Queue](#ุงููุฑุญูุฉ-ุงูุซุงููุฉ-ุฅุถุงูุฉ-ุงูุฑุณุงูุฉ-ุฅูู-redis-queue)
4. [ุงููุฑุญูุฉ ุงูุซุงูุซุฉ: ูุงูุฐุฉ ุงูุงูุชุธุงุฑ 8 ุซูุงูู](#ุงููุฑุญูุฉ-ุงูุซุงูุซุฉ-ูุงูุฐุฉ-ุงูุงูุชุธุงุฑ-8-ุซูุงูู)
5. [ุงููุฑุญูุฉ ุงูุฑุงุจุนุฉ: ูุนุงูุฌุฉ ูุฌููุนุฉ ุงูุฑุณุงุฆู](#ุงููุฑุญูุฉ-ุงูุฑุงุจุนุฉ-ูุนุงูุฌุฉ-ูุฌููุนุฉ-ุงูุฑุณุงุฆู)
6. [ูุธุงู Customer Profiles - ุงูุชุญููู ุงูููุตู](#ูุธุงู-customer-profiles---ุงูุชุญููู-ุงูููุตู)
7. [ูุธุงู Data Collection - ุงูุชุญููู ุงูููุตู](#ูุธุงู-data-collection---ุงูุชุญููู-ุงูููุตู)
8. [ุงูุฃูุธูุฉ ุงูุฃุฎุฑู ูู ุงูุชุฏูู](#ุงูุฃูุธูุฉ-ุงูุฃุฎุฑู-ูู-ุงูุชุฏูู)
9. [ุฃูุซูุฉ ุนูููุฉ ุดุงููุฉ](#ุฃูุซูุฉ-ุนูููุฉ-ุดุงููุฉ)
10. [ูุฎุทุทุงุช ุงูุชุฏูู](#ูุฎุทุทุงุช-ุงูุชุฏูู)

---

## ูุธุฑุฉ ุนุงูุฉ ุนูู ุงููุธุงู

ูุธุงู ConvGo ูุณุชุฎุฏู **ูุธุงู ูุงุฆูุฉ ุงูุชุธุงุฑ ุฐูู** (Smart Queue System) ููุนุงูุฌุฉ ุฑุณุงุฆู WhatsApp ุจููุงุกุฉ ุนุงููุฉ. ุงููุธุงู ูุตูู ูุฌูุน ุงูุฑุณุงุฆู ุงููุชุชุงููุฉ ูู ููุณ ุงูุนููู ููุนุงูุฌุชูุง ูุนุงู ูู **ูุงูุฐุฉ ุฒูููุฉ ูุฏุฑูุง 8 ุซูุงูู** ูุชุญุณูู ุฌูุฏุฉ ุงูุงุณุชุฌุงุจุฉ ูููู ุงูุณูุงู ุจุดูู ุฃูุถู.

### **ุงููุจุฏุฃ ุงูุฃุณุงุณู:**
```
ุฑุณุงุฆู ูุชุนุฏุฏุฉ + ูุนุงูุฌุฉ ูุฌูุนุฉ = ุงุณุชุฌุงุจุฉ ุฃูุถู + ููุงุกุฉ ุฃุนูู
```

---

## ุงููุฑุญูุฉ ุงูุฃููู: ุงุณุชูุจุงู ุงูุฑุณุงูุฉ ูู ุงูููุจ ููู

### **๐ ุงููููุน:** `supabase/functions/whatsapp-webhook/index.ts`

ุนูุฏูุง ุชุตู ุฑุณุงูุฉ WhatsApp ุฌุฏูุฏุฉุ ุชูุฑ ุจุงููุฑุงุญู ุงูุชุงููุฉ:

### **1.1 ุงูุชุญูู ุงูุฃููู**
```typescript
// ุงูุชุญูู ูู ุตุญุฉ ุงูุจูุงูุงุช ุงููุงุฑุฏุฉ
if (!instanceName || !userPhone || !messageData) {
  return error_response;
}
```

### **1.2 ูุนุงูุฌุฉ ููุน ุงูุฑุณุงูุฉ**
```typescript
// ุฏุนู ุฃููุงุน ูุฎุชููุฉ ูู ุงูุฑุณุงุฆู
const messageText = messageData.transcribedText ||                    // Voice messages (transcribed)
                   messageData.message?.conversation ||               // Regular text messages
                   messageData.message?.extendedTextMessage?.text ||  // Extended text messages  
                   messageData.message?.imageMessage?.caption ||      // Images with captions
                   '[Media Message]';                                 // Fallback for media without text
```

### **1.3 ูุญุต ุงูุญุงูุงุช ุงูุฎุงุตุฉ**
- **ุงููุญุงุฏุซุงุช ุงูููุฑูุนุฉ (Escalated):** ุงูุชุญูู ูู ูุฌูุฏ ุทูุจ ุชุฏุฎู ุจุดุฑู
- **ุฑุณุงุฆู ุงูุงุชุตุงู:** ูุนุงูุฌุฉ ุฑุณุงุฆู ุชุบููุฑ ุญุงูุฉ ุงูุงุชุตุงู
- **ุงูุฑุณุงุฆู ุงูุตูุชูุฉ:** ุชุญููู ุงูุตูุช ุฅูู ูุต ูุจู ุงููุนุงูุฌุฉ

### **1.4 ุงุชุฎุงุฐ ูุฑุงุฑ ุงููุนุงูุฌุฉ**
```typescript
// ูุญุงููุฉ ุฅุถุงูุฉ ุฅูู Queue ุฃููุงูุ ุซู ุงูุชุฑุงุฌุน ูููุนุงูุฌุฉ ุงููุจุงุดุฑุฉ
try {
  const queueResult = await addToQueue(instanceName, userPhone, normalizedData);
  if (queueResult.success) {
    // ูุฌุญุช ุฅุถุงูุฉ ุฅูู Queue
    return success_response;
  }
} catch (error) {
  // ูุดู Queueุ ุงุณุชุฎุฏุงู ุงููุนุงูุฌุฉ ุงููุจุงุดุฑุฉ
  const directResult = await processMessageDirectly(messageData);
  return directResult;
}
```

---

## ุงููุฑุญูุฉ ุงูุซุงููุฉ: ุฅุถุงูุฉ ุงูุฑุณุงูุฉ ุฅูู Redis Queue

### **๐ ุงููููุน:** `supabase/functions/_shared/redis-queue.ts`

### **2.1 ุฅูุดุงุก ูุนุฑู ูุฑูุฏ ููุฑุณุงูุฉ**
```typescript
function generateMessageId(): string {
  return `msg_${Date.now()}_${Math.random().toString(36).substring(7)}`;
}
```

### **2.2 ุชูููู ููุงุชูุญ Redis**
```typescript
// ููุชุงุญ ุงููุงุฆูุฉ ููุนููู ุงููุญุฏุฏ
function getQueueKey(instanceName: string, userPhone: string): string {
  return `msg_queue:${instanceName}:${userPhone}`;
}

// ููุชุงุญ ุงูููู ูููุน ุงููุนุงูุฌุฉ ุงููุฒุฏูุฌุฉ
function getLockKey(instanceName: string, userPhone: string): string {
  return `processing_lock:${instanceName}:${userPhone}`;
}
```

### **2.3 ุฅูุดุงุก ูุงุฆู ุงูุฑุณุงูุฉ**
```typescript
const queueMessage: QueueMessage = {
  id: messageId,                           // ูุนุฑู ูุฑูุฏ
  instanceName,                            // ุงุณู ูุซูู WhatsApp
  userPhone,                               // ุฑูู ุงูุนููู
  message: messageText,                    // ูุต ุงูุฑุณุงูุฉ
  messageData,                             // ุงูุจูุงูุงุช ุงููุงููุฉ ููุฑุณุงูุฉ
  timestamp: messageData.messageTimestamp, // ููุช ุงูุฑุณุงูุฉ ุงูุฃุตูู
  addedAt: now,                           // ููุช ุงูุฅุถุงูุฉ ูููุงุฆูุฉ
  status: 'pending',                      // ุญุงูุฉ ุงูุฑุณุงูุฉ
  retryCount: 0                           // ุนุฏุฏ ุงููุญุงููุงุช
};
```

### **2.4 ุงูุฅุถุงูุฉ ุงูุฐุฑูุฉ ุฅูู Redis**
```typescript
// ุนูููุฉ ุฐุฑูุฉ ูุถูุงู ุนุฏู ููุฏุงู ุงูุจูุงูุงุช
await client.multi()
  .lpush(queueKey, JSON.stringify(queueMessage))  // ุฅุถุงูุฉ ูููุงุฆูุฉ
  .expire(queueKey, QUEUE_TTL)                    // ุชุนููู ุงูุชูุงุก ุตูุงุญูุฉ
  .sadd('active_queues', queueKey)                // ุฅุถุงูุฉ ููููุงุฆู ุงููุดุทุฉ
  .exec();
```

---

## ุงููุฑุญูุฉ ุงูุซุงูุซุฉ: ูุงูุฐุฉ ุงูุงูุชุธุงุฑ 8 ุซูุงูู

### **๐ ุงููููุน:** `supabase/functions/_shared/queue-processor.ts`

ูุฐู ูู **ุงูููุทุฉ ุงูุฃุณุงุณูุฉ** ูู ุงููุธุงู ุญูุซ ูุญุฏุซ "ุงูุณุญุฑ":

### **3.1 ุดุฑูุท ุงููุนุงูุฌุฉ**
```typescript
// ุงููุงุนุฏุฉ ุงูุฐูุจูุฉ: ุงูุชุธุงุฑ 8 ุซูุงูู ุฃู ูุตูู 5 ุฑุณุงุฆู
if (timeSinceFirst < 8000 && messages.length < 5) {
  logger.debug('โณ Queue not ready - enforcing 8-second wait', {
    messageCount: messages.length,
    timeSinceFirst,
    remainingTime: 8000 - timeSinceFirst,
    reason: 'waiting_for_8_seconds_or_5_messages'
  });
  return false; // ูุง ุชุนุงูุฌ ููุงุฆูุงู
}
```

### **3.2 ููุทู ุงุชุฎุงุฐ ุงููุฑุงุฑ**
```typescript
// ูุฑุงุฑ ุงููุนุงูุฌุฉ
const shouldProcess = timeSinceFirst >= 8000 || messages.length >= 5;

if (shouldProcess) {
  const trigger = timeSinceFirst >= 8000 ? '8_second_timeout' : 'message_count_limit';
  const processingReason = messages.length >= 5 ? 'reached_5_messages' : 'completed_8_second_wait';
  
  logger.debug('โ Queue ready for processing', {
    messageCount: messages.length,
    timeSinceFirst,
    trigger,
    processingReason
  });
}
```

### **3.3 ุณููุงุฑูููุงุช ูุฎุชููุฉ ูููุนุงูุฌุฉ**

#### **ุงูุณููุงุฑูู ุงูุฃูู: ุงูุชูุงุก 8 ุซูุงูู**
```
ุงูุนููู: "ุงูุณูุงู ุนูููู"
[ุงูุชุธุงุฑ 8 ุซูุงูู]
โ ูุนุงูุฌุฉ ุฑุณุงูุฉ ูุงุญุฏุฉ
```

#### **ุงูุณููุงุฑูู ุงูุซุงูู: ูุตูู 5 ุฑุณุงุฆู ูุจู 8 ุซูุงูู**
```
ุงูุนููู: "ุงูุณูุงู ุนูููู"      (ุซุงููุฉ 1)
ุงูุนููู: "ุฃุฑูุฏ ููุชุฌ"         (ุซุงููุฉ 2)
ุงูุนููู: "ุงุณูู ุฃุญูุฏ"         (ุซุงููุฉ 3)
ุงูุนููู: "ุฑููู 123456"      (ุซุงููุฉ 4)
ุงูุนููู: "ุฃูู ุฃูุชูุ"         (ุซุงููุฉ 5)
โ ูุนุงูุฌุฉ ููุฑูุฉ ูู 5 ุฑุณุงุฆู (ูู ุชูุชูู 8 ุซูุงูู ุจุนุฏ)
```

#### **ุงูุณููุงุฑูู ุงูุซุงูุซ: ุฑุณุงุฆู ูุชุชุงููุฉ ุฎูุงู ุงููุงูุฐุฉ**
```
ุงูุนููู: "ุงูุณูุงู ุนูููู"      (ุซุงููุฉ 1)
ุงูุนููู: "ุฃุฑูุฏ ุงุณุชูุณุงุฑ"      (ุซุงููุฉ 4)
ุงูุนููู: "ุนุงุฌู ูู ูุถูู"      (ุซุงููุฉ 7)
[ุงูุชุธุงุฑ ุญุชู ุซุงููุฉ 9]
โ ูุนุงูุฌุฉ 3 ุฑุณุงุฆู ูุนุงู
```

---

## ุงููุฑุญูุฉ ุงูุฑุงุจุนุฉ: ูุนุงูุฌุฉ ูุฌููุนุฉ ุงูุฑุณุงุฆู

### **4.1 ุชุฌููุน ุงูุฑุณุงุฆู**
```typescript
// ุฏูุฌ ุฌููุน ุงูุฑุณุงุฆู ูู ุฑุณุงูุฉ ูุงุญุฏุฉ
const combinedMessage = messagesToProcess
  .map(msg => msg.message)
  .join('\n\n');
```

### **4.2 ุชุณูุณู ุงููุนุงูุฌุฉ**
1. **ุฅูุดุงุก ุงูุณูุงู (Context Assembly)**
2. **ุชุญุฏูุซ ููู ุงูุนููู (Customer Profile)**
3. **ุงุณุชุฎุฑุงุฌ ุงูุจูุงูุงุช (Data Collection)**
4. **ุฅูุชุงุฌ ุงูุฑุฏ ุจุงูุฐูุงุก ุงูุงุตุทูุงุนู**
5. **ุฅุฑุณุงู ุงูุฑุฏ ุนุจุฑ WhatsApp**

---

## ูุธุงู Customer Profiles - ุงูุชุญููู ุงูููุตู

### **๐ฏ ุงููุฏู:** ุฅุฏุงุฑุฉ ูุชุญููู ูููุงุช ุงูุนููุงุก ุจุฐูุงุก

### **ุงูุชุทุจูู ูู ุชุฏูู ุงูุฑุณุงุฆู:**

#### **ุฎุทูุฉ 1: ุงูุญุตูู ุนูู/ุฅูุดุงุก ููู ุงูุนููู**
```typescript
// ูู queue-processor.ts
const customerProfile = await customerProfileManager.getOrCreateProfile(
  instanceData.id,
  userPhone
);
```

#### **ุฎุทูุฉ 2: ุงูุชุญุฏูุซ ุงูุฐูู ููููู**
```typescript
// ุงุณุชุฎุฏุงู Smart Batching - ุชุญุฏูุซ ูู 5 ุฑุณุงุฆู ุจุฏูุงู ูู ูู ุฑุณุงูุฉ
await smartCustomerProfileManager.processMessage(
  instanceData.id,
  userPhone,
  combinedMessage
);
```

### **๐ง ุงููุธุงู ุงูุฐูู (Smart Batching):**

#### **ุงููุงุนุฏุฉ ุงูุฐููุฉ:**
- **ุงูุชุญุฏูุซ ุงููุงูู:** ูู 5 ุฑุณุงุฆู
- **ุงูุชุญุฏูุซ ุงูุณุฑูุน:** ุญุงูุฉ ุงููุฒุงุฌ ููุท ููุฑุณุงุฆู ุงูุฃุฎุฑู

```typescript
// ูู smart-customer-profile-manager.ts
if (messagesSinceUpdate >= this.SUMMARY_UPDATE_THRESHOLD) { // 5 ุฑุณุงุฆู
  // ุชุญุฏูุซ ุดุงูู ูุน AI
  await this.updateConversationSummaryFromRecentMessages(instanceId, phoneNumber);
  await this.updateMessagesSinceLastSummary(instanceId, phoneNumber, 0);
} else {
  // ุชุญุฏูุซ ุณุฑูุน ูููุฒุงุฌ ููุท
  await this.quickMoodUpdate(instanceId, phoneNumber, message);
}
```

### **๐ ูุนูููุงุช ูุชู ุชุชุจุนูุง:**

#### **ุงููุนูููุงุช ุงูุฃุณุงุณูุฉ:**
- **ุงูุงุณูุ ุงูุจุฑูุฏ ุงูุฅููุชุฑูููุ ุงูุดุฑูุฉ**
- **ูุฑุญูุฉ ุงูุนููู:** `new | interested | customer | loyal`
- **ุงูุนูุงูุงุช (Tags)** ูุงูุชูุถููุงุช

#### **ุงูุชุญููู ุจุงูุฐูุงุก ุงูุงุตุทูุงุนู:**
```typescript
interface CustomerInsights {
  customer_intent: 'purchase' | 'inquiry' | 'support' | 'complaint' | 'comparison';
  customer_mood: 'happy' | 'frustrated' | 'neutral' | 'excited' | 'confused';
  urgency_level: 'urgent' | 'high' | 'normal' | 'low';
  communication_style: 'formal' | 'friendly' | 'direct' | 'detailed';
  journey_stage: 'first_time' | 'researching' | 'ready_to_buy' | 'existing_customer';
}
```

#### **ุฅุญุตุงุฆูุงุช ุงูุชูุงุนู:**
- **ุฅุฌูุงูู ุงูุฑุณุงุฆู:** ุนุฏุฏ ุฑุณุงุฆู ุงูุนููู
- **ุชูุงุนูุงุช ุงูุฐูุงุก ุงูุงุตุทูุงุนู:** ุนุฏุฏ ุฑุฏูุฏ ุงููุธุงู
- **ุฃูู ูุขุฎุฑ ุชูุงุนู:** ุชุชุจุน ุงูุฌุฏููุฉ ุงูุฒูููุฉ

### **ูุซุงู ุนููู ูู Customer Profile:**

```json
{
  "id": "cust_12345",
  "phone_number": "+201012345678",
  "name": "ุฃุญูุฏ ูุญูุฏ",
  "customer_stage": "interested",
  "customer_intent": "purchase",
  "customer_mood": "excited",
  "urgency_level": "high",
  "communication_style": "direct",
  "journey_stage": "ready_to_buy",
  "total_messages": 12,
  "ai_interactions": 8,
  "conversation_summary": "ุนููู ููุชู ุจุดุฑุงุก ุฌูุงุฒ iPhone 15ุ ุณุฃู ุนู ุงูุฃุณุนุงุฑ ูุงูุฃููุงู ุงููุชุงุญุฉุ ูุจุฏู ูุชุญูุณ ููุดุฑุงุก",
  "key_points": [
    "ููุถู ุงูููู ุงูุฃุฒุฑู",
    "ููุฒุงููุชู ุญูุงูู 50,000 ุฌููู",
    "ูุฑูุฏ ุงูุชูุตูู ููุฏููุฉ ูุตุฑ"
  ],
  "messages_since_last_summary": 2
}
```

---

## ูุธุงู Data Collection - ุงูุชุญููู ุงูููุตู

### **๐ฏ ุงููุฏู:** ุฌูุน ุงูุจูุงูุงุช ุงูููุธูุฉ ูู ุงููุญุงุฏุซุงุช ูุชุตุฏูุฑูุง ุฅูู Google Sheets

### **ุงูุชุทุจูู ูู ุชุฏูู ุงูุฑุณุงุฆู:**

#### **ุฎุทูุฉ 1: ุงูุชุญูู ูู ุชูุนูู ุฌูุน ุงูุจูุงูุงุช**
```typescript
// ูู queue-processor.ts
const dataCollectionEnabled = await isDataCollectionEnabled(instanceData.id, supabaseAdmin);
```

#### **ุฎุทูุฉ 2: ูุนุงูุฌุฉ ุงุณุชุฎุฑุงุฌ ุงูุจูุงูุงุช**
```typescript
if (dataCollectionEnabled && dataCollectionFields.length > 0) {
  await processDataExtraction(
    instanceData.id,
    conversationId,
    userPhone,
    combinedMessage,
    conversationHistory,  // โ ุฑุณุงุฆู ุงูุนููู ููุท (ุชู ุชุญุณูููุง)
    supabaseUrl,
    supabaseServiceKey
  );
}
```

### **๐ ุชุฏูู ุงุณุชุฎุฑุงุฌ ุงูุจูุงูุงุช:**

#### **1. ุฌูุจ ุชูููู ุงูุญููู**
```typescript
// ุงูุญููู ุงููุทููุจ ุฌูุนูุง ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
const fields = await supabase
  .from('data_collection_fields')
  .select('*')
  .eq('config_id', configId)
  .eq('is_active', true)
  .order('field_order');
```

#### **2. ุฅุฏุงุฑุฉ ุฌูุณุฉ ุฌูุน ุงูุจูุงูุงุช**
```typescript
// ุฅูุดุงุก ุฃู ุงุณุชุฑุฌุงุน ุฌูุณุฉ ููุนููู
let session = await supabase
  .from('collected_data_sessions')
  .select('*')
  .eq('config_id', configId)
  .eq('conversation_id', conversationId)
  .single();

if (!session) {
  // ุฅูุดุงุก ุฌูุณุฉ ุฌุฏูุฏุฉ
  session = await createNewDataCollectionSession(configId, conversationId, phoneNumber, fields);
}
```

#### **3. ุงุณุชุฎุฑุงุฌ ุงูุจูุงูุงุช ุจุงูุฐูุงุก ุงูุงุตุทูุงุนู**
```typescript
// ุฅุฑุณุงู ููู OpenAI GPT-4o-mini ูุงุณุชุฎุฑุงุฌ ุงูุจูุงูุงุช
const systemPrompt = `You are a data extraction assistant...
Fields to extract:
${fieldsDescription}

Current collected data:
${JSON.stringify(session.collected_data)}`;

const userPrompt = `Current message: "${combinedMessage}"

Conversation history (customer messages only):
${conversationHistory.map(msg => `${msg.from}: ${msg.message}`).join('\n')}`;
```

#### **4. ูุนุงูุฌุฉ ุงููุชุงุฆุฌ**
```typescript
// ุชุญููู ุงุณุชุฌุงุจุฉ ุงูุฐูุงุก ุงูุงุตุทูุงุนู
const extractedData = JSON.parse(aiResponse.choices[0].message.content);

// ุฑุจุท ุฃุณูุงุก ุงูุนุฑุถ ุจุฃุณูุงุก ุงูุญููู ุงูุฏุงุฎููุฉ
const mappedData = mapDisplayNamesToFieldNames(extractedData, fields);

// ุงูุชุญูู ูู ุตุญุฉ ุงูุจูุงูุงุช
const validatedData = validateExtractedData(mappedData, fields);

// ุญุณุงุจ ุงูุญููู ุงููุงูุตุฉ
const missingFields = calculateMissingRequiredFields(validatedData, fields);
```

#### **5. ุชุญุฏูุซ ุงูุฌูุณุฉ**
```typescript
// ุชุญุฏูุซ ุฌูุณุฉ ุฌูุน ุงูุจูุงูุงุช
await supabase
  .from('collected_data_sessions')
  .update({
    collected_data: updatedData,
    missing_fields: missingFields,
    is_complete: missingFields.length === 0,
    last_message_at: new Date().toISOString()
  })
  .eq('id', session.id);
```

#### **6. ุงูุชุตุฏูุฑ ุนูุฏ ุงูุงูุชูุงู**
```typescript
if (isComplete) {
  // ุชุตุฏูุฑ ุชููุงุฆู ุฅูู Google Sheets
  const exportResponse = await fetch(`${supabaseUrl}/functions/v1/sheets-exporter`, {
    method: 'POST',
    headers: {
      'Authorization': `Bearer ${supabaseServiceRoleKey}`,
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({ sessionId: session.id })
  });
}
```

### **๐ ุฃููุงุน ุงูุญููู ุงููุฏุนููุฉ:**

```typescript
type FieldType = 'text' | 'phone' | 'email' | 'number' | 'date' | 'address' | 'select' | 'boolean';
```

### **ูุซุงู ุนููู ูู Data Collection:**

#### **ุฅุนุฏุงุฏ ุงูุญููู:**
```json
[
  {
    "field_name": "customer_name",
    "field_display_name": "Customer Name", 
    "field_display_name_ar": "ุงุณู ุงูุนููู",
    "field_type": "text",
    "is_required": true,
    "extraction_keywords": ["ุงุณู", "name", "ูุณูู"]
  },
  {
    "field_name": "phone",
    "field_display_name": "Phone Number",
    "field_display_name_ar": "ุฑูู ุงููุงุชู", 
    "field_type": "phone",
    "is_required": true,
    "extraction_keywords": ["ูุงุชู", "ุฑูู", "phone"]
  }
]
```

#### **ุงููุญุงุฏุซุฉ:**
```
ุงูุนููู: "ุงูุณูุงู ุนูููู"
ุงููุณุงุนุฏ: "ูุนูููู ุงูุณูุงูุ ููู ูููููู ูุณุงุนุฏุชูุ"
ุงูุนููู: "ุฃุฑูุฏ ุฃุทูุจ ููุชุฌ"
ุงูุนููู: "ุงุณูู ุฃุญูุฏ ูุญูุฏ"
ุงูุนููู: "ุฑููู 01012345678"
[ุงูุชูุงุก ูุงูุฐุฉ 8 ุซูุงูู]
```

#### **ุงุณุชุฎุฑุงุฌ ุงูุจูุงูุงุช:**
```json
{
  "ุงุณู ุงูุนููู": "ุฃุญูุฏ ูุญูุฏ",
  "ุฑูู ุงููุงุชู": "01012345678"
}
```

#### **ุญูุธ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช:**
```json
{
  "session_id": "session_12345",
  "collected_data": {
    "customer_name": "ุฃุญูุฏ ูุญูุฏ", 
    "phone": "01012345678"
  },
  "missing_fields": [],
  "is_complete": true,
  "exported_to_sheets": true
}
```

#### **ุชุตุฏูุฑ ุฅูู Google Sheets:**
| Timestamp | Phone Number | Conversation ID | Customer Name | Phone |
|-----------|-------------|-----------------|---------------|--------|
| 2024-09-26 15:30:25 | +201012345678 | conv_12345 | ุฃุญูุฏ ูุญูุฏ | 01012345678 |

---

## ุงูุฃูุธูุฉ ุงูุฃุฎุฑู ูู ุงูุชุฏูู

### **1. ูุธุงู Smart Escalation**
- **ูุญุต ุงููููุงุช ุงูููุชุงุญูุฉ:** ุชุญุฏูุฏ ุฅุฐุง ูุงูุช ุงูุฑุณุงูุฉ ุชุญุชุงุฌ ุชุฏุฎู ุจุดุฑู
- **ุชุญููู ุงูุฐูุงุก ุงูุงุตุทูุงุนู:** ููู ููุฉ ุงูุนููู ูุทูุจ ุงููุณุงุนุฏุฉ ุงูุจุดุฑูุฉ
- **ุฅุดุนุงุฑุงุช ููุฑูุฉ:** ุฅุฑุณุงู ุชูุจููุงุช ูููุฑูู ุงูุจุดุฑู

### **2. ูุนุงูุฌุฉ ุงููุณุงุฆุท ุงููุชุนุฏุฏุฉ**
- **ุงูุฑุณุงุฆู ุงูุตูุชูุฉ:** ุชุญููู ุฅูู ูุต ุจุงุณุชุฎุฏุงู Whisper
- **ุงูุตูุฑ:** ุงุณุชุฎุฑุงุฌ ุงููุต ูุงูุชุญููู ุจุงูู Vision AI
- **ุงููุณุชูุฏุงุช:** ุงุณุชุฎุฑุงุฌ ุงููุญุชูู ูุชุญูููู

### **3. ูุธุงู RAG (Retrieval-Augmented Generation)**
- **ุงูุจุญุซ ูู ูุงุนุฏุฉ ุงููุนุฑูุฉ:** ุงุณุชุฑุฌุงุน ุงููุนูููุงุช ุฐุงุช ุงูุตูุฉ
- **ุชุฌููุน ุงูุณูุงู:** ุฏูุฌ ุงููุนูููุงุช ุงููุณุชุฑุฌุนุฉ ูุน ุงููุญุงุฏุซุฉ
- **ุชุญุณูู ุงูุฑุฏูุฏ:** ุฅุซุฑุงุก ุฑุฏูุฏ ุงูุฐูุงุก ุงูุงุตุทูุงุนู ุจุงููุนูููุงุช ุงูุฏูููุฉ

### **4. ูุธุงู External Actions**
- **ุชุดุบูู ุงูุฅุฌุฑุงุกุงุช ุงูุฎุงุฑุฌูุฉ:** ุงุณุชุฏุนุงุก APIs ุฎุงุฑุฌูุฉ ุญุณุจ ููุฉ ุงูุนููู
- **ุชูููุฐ ุงูููุงู:** ุฅูุดุงุก ุทูุจุงุชุ ุญุฌุฒ ููุงุนูุฏุ ุฅุฑุณุงู ุฅูุตุงูุงุช
- **ุงูุชูุงูู ูุน ุงูุฃูุธูุฉ:** CRMุ ERPุ ุฃูุธูุฉ ุงูุฏูุน

---

## ุฃูุซูุฉ ุนูููุฉ ุดุงููุฉ

### **ูุซุงู 1: ุนููู ุฌุฏูุฏ ูุทูุจ ููุชุฌ**

#### **ุงูุชุฏูู ุงููุงูู:**

**1. ุงุณุชูุจุงู ุงูุฑุณุงุฆู (ุฎูุงู 8 ุซูุงูู):**
```
[ุซุงููุฉ 1] ุงูุนููู: "ุงูุณูุงู ุนูููู"
[ุซุงููุฉ 3] ุงูุนููู: "ุฃุฑูุฏ ุฃุดุชุฑู ูุงุจุชูุจ"
[ุซุงููุฉ 5] ุงูุนููู: "ุงุณูู ุณุงุฑุฉ ุฃุญูุฏ"
[ุซุงููุฉ 7] ุงูุนููู: "ุฑููู 01123456789"
[ุซุงููุฉ 9] โ ุชุดุบูู ุงููุนุงูุฌุฉ
```

**2. ุงููุนุงูุฌุฉ ุงููุฌูุนุฉ:**
```typescript
const combinedMessage = `ุงูุณูุงู ุนูููู

ุฃุฑูุฏ ุฃุดุชุฑู ูุงุจุชูุจ

ุงุณูู ุณุงุฑุฉ ุฃุญูุฏ

ุฑููู 01123456789`;
```

**3. Customer Profile Management:**
```json
{
  "action": "create_new_profile",
  "extracted_info": {
    "name": "ุณุงุฑุฉ ุฃุญูุฏ",
    "phone": "01123456789",
    "customer_stage": "new",
    "customer_intent": "purchase",
    "customer_mood": "neutral",
    "urgency_level": "normal",
    "journey_stage": "first_time"
  }
}
```

**4. Data Collection (ุฅุฐุง ูุงู ููุนู):**
```json
{
  "extracted_data": {
    "ุงุณู ุงูุนููู": "ุณุงุฑุฉ ุฃุญูุฏ",
    "ุฑูู ุงููุงุชู": "01123456789",
    "ุงูููุชุฌ ุงููุทููุจ": "ูุงุจุชูุจ"
  },
  "missing_fields": ["ุงูุนููุงู", "ุงูููุฒุงููุฉ"],
  "is_complete": false
}
```

**5. ุฅูุชุงุฌ ุงูุฑุฏ:**
```
"ูุฑุญุจุงู ุฃุณุชุงุฐุฉ ุณุงุฑุฉ! ๐

ุดูุฑุงู ูุชูุงุตูู ูุนูุง. ุณุฃููู ุณุนูุฏ ููุณุงุนุฏุชู ูู ุงุฎุชูุงุฑ ุงููุงุจุชูุจ ุงูููุงุณุจ.

ูุฏููุง ูุฌููุนุฉ ููุชุงุฒุฉ ูู ุฃุฌูุฒุฉ ุงููุงุจุชูุจ ุจููุงุตูุงุช ูุฎุชููุฉ:
- Dell XPS 13 - 35,000 ุฌููู
- HP Pavilion 15 - 25,000 ุฌููู  
- MacBook Air M2 - 55,000 ุฌููู

ูู ููููู ุฅุฎุจุงุฑู ุจุงูููุฒุงููุฉ ุงูุชูุฑูุจูุฉ ูุงูุงุณุชุฎุฏุงู ุงููุทููุจ ููุฌูุงุฒุ"
```

**6. ุทูุจ ุงูุญููู ุงููุงูุตุฉ (Data Collection):**
```
"ูู ุณูุญุชุ ูู ููููู ุฅุฎุจุงุฑู ุจุงูุนููุงู ููุชูุตููุ"
```

### **ูุซุงู 2: ุนููู ุญุงูู ูุฏูู ูุดููุฉ**

#### **ุงูุชุฏูู:**

**1. ุงูุฑุณุงุฆู ุงููุณุชูุจูุฉ:**
```
[ุซุงููุฉ 1] ุงูุนููู: "ุนูุฏู ูุดููุฉ ูู ุงูุฌูุงุฒ ุงููู ุงุดุชุฑูุชู"
[ุซุงููุฉ 4] ุงูุนููู: "ูุด ุดุบุงู ุฎุงูุต"
[ุซุงููุฉ 6] ุงูุนููู: "ูุญุชุงุฌ ุญู ุณุฑูุน"
[ุซุงููุฉ 8] โ ุชุดุบูู ุงููุนุงูุฌุฉ
```

**2. Customer Profile Update:**
```json
{
  "action": "update_existing_profile", 
  "changes": {
    "customer_intent": "support",
    "customer_mood": "frustrated", 
    "urgency_level": "urgent",
    "last_interaction": "2024-09-26T15:30:00Z"
  }
}
```

**3. Smart Escalation Check:**
```json
{
  "escalation_needed": true,
  "reason": "urgent_technical_issue",
  "keywords_detected": ["ูุดููุฉ", "ูุด ุดุบุงู", "ูุญุชุงุฌ ุญู ุณุฑูุน"]
}
```

**4. ุฅูุชุงุฌ ุงูุฑุฏ ูุน ุงูุฅุฑูุงู:**
```
"ุฃุนุชุฐุฑ ุจุดุฏุฉ ุนู ูุฐู ุงููุดููุฉ! ๐

ุณุฃููู ููุฑุงู ุจุชุญูููู ููุฑูู ุงูุฏุนู ุงูููู ุงููุชุฎุตุต ูุญู ูุดููุฉ ุงูุฌูุงุฒ ุจุฃุณุฑุน ููุช ูููู.

ุฑูู ุทูุจ ุงูุฏุนู: #TECH-2024-001234

ุณูุชูุงุตู ูุนู ุฃุญุฏ ุงูููููู ุฎูุงู 15 ุฏูููุฉ ูุญู ุงููุดููุฉ.

ูุนุชุฐุฑ ูุฑุฉ ุฃุฎุฑู ุนู ุงูุฅุฒุนุงุฌ! ๐งโจ"
```

### **ูุซุงู 3: ุนููู ูุฑุณู 5 ุฑุณุงุฆู ุณุฑูุนุฉ**

#### **ุงูุณููุงุฑูู:**
```
[ุซุงููุฉ 1] ุงูุนููู: "ูุฑุญุจุง"
[ุซุงููุฉ 2] ุงูุนููู: "ุนุงูุฒ ุงุณุชูุณุฑ" 
[ุซุงููุฉ 3] ุงูุนููู: "ุนู ุงูุฃุณุนุงุฑ"
[ุซุงููุฉ 4] ุงูุนููู: "ููููุจุงููุงุช"
[ุซุงููุฉ 5] ุงูุนููู: "ุงููุชุงุญุฉ ุนูุฏูู"
โ ูุนุงูุฌุฉ ููุฑูุฉ (ูุตูุช 5 ุฑุณุงุฆู ูุจู ุงูุชูุงุก 8 ุซูุงูู)
```

#### **ุงููุนุงูุฌุฉ:**
```typescript
const processingReason = 'reached_5_messages';
const trigger = 'message_count_limit';
const combinedMessage = `ูุฑุญุจุง

ุนุงูุฒ ุงุณุชูุณุฑ

ุนู ุงูุฃุณุนุงุฑ

ููููุจุงููุงุช

ุงููุชุงุญุฉ ุนูุฏูู`;
```

---

## ูุฎุทุทุงุช ุงูุชุฏูู

### **ูุฎุทุท ุงูุชุฏูู ุงูุฑุฆูุณู:**

```mermaid
graph TD
    A[ุฑุณุงูุฉ WhatsApp ูุงุฑุฏุฉ] --> B[webhook: ุงุณุชูุจุงู ูุชุญููู]
    B --> C{ููุน ุงูุฑุณุงูุฉุ}
    
    C -->|ูุต ุนุงุฏู| D[addToQueue: ุฅุถุงูุฉ ูู Redis]
    C -->|ุตูุช| E[ุชุญููู ุตูุช ููุต] --> D
    C -->|ุตูุฑุฉ| F[ุงุณุชุฎุฑุงุฌ ูุต ูู ุตูุฑุฉ] --> D
    
    D --> G[Redis Queue: ุงูุชุธุงุฑ 8 ุซูุงูู]
    G --> H{ุดุฑูุท ุงููุนุงูุฌุฉุ}
    
    H -->|8 ุซูุงูู ูุถุช| I[queue-processor: ูุนุงูุฌุฉ ุงูุฑุณุงุฆู]
    H -->|5 ุฑุณุงุฆู ูุตูุช| I
    H -->|ูุง| G
    
    I --> J[ุชุฌููุน ุงูุฑุณุงุฆู]
    J --> K[Customer Profile: ุชุญุฏูุซ/ุฅูุดุงุก]
    K --> L[Data Collection: ุงุณุชุฎุฑุงุฌ ุงูุจูุงูุงุช]
    L --> M[AI Response: ุฅูุชุงุฌ ุงูุฑุฏ]
    M --> N[WhatsApp: ุฅุฑุณุงู ุงูุฑุฏ]
    
    K --> O[Smart Batching: ูู 5 ุฑุณุงุฆู]
    L --> P[Google Sheets: ุชุตุฏูุฑ ุนูุฏ ุงูุงูุชูุงู]
```

### **ูุฎุทุท Customer Profile System:**

```mermaid
graph LR
    A[ุฑุณุงูุฉ ุฌุฏูุฏุฉ] --> B{ููู ููุฌูุฏุ}
    B -->|ูุง| C[ุฅูุดุงุก ููู ุฌุฏูุฏ]
    B -->|ูุนู| D[ุฌูุจ ุงูููู ุงูุญุงูู]
    
    C --> E[Smart Profile Manager]
    D --> E
    
    E --> F{ุนุฏุฏ ุงูุฑุณุงุฆู โฅ 5ุ}
    F -->|ูุนู| G[ุชุญุฏูุซ ุดุงูู ุจู AI]
    F -->|ูุง| H[ุชุญุฏูุซ ุณุฑูุน ูููุฒุงุฌ]
    
    G --> I[reset counter to 0]
    H --> J[increment counter]
    
    I --> K[ุญูุธ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช]
    J --> K
```

### **ูุฎุทุท Data Collection System:**

```mermaid
graph TB
    A[ุจุฏุก Data Collection] --> B{ููุนู ูููุซููุ}
    B -->|ูุง| Z[ุชุฎุทู ุงุณุชุฎุฑุงุฌ ุงูุจูุงูุงุช]
    B -->|ูุนู| C[ุฌูุจ ุชูููู ุงูุญููู]
    
    C --> D{ุฌูุณุฉ ููุฌูุฏุฉุ}
    D -->|ูุง| E[ุฅูุดุงุก ุฌูุณุฉ ุฌุฏูุฏุฉ]
    D -->|ูุนู| F[ุงุณุชุฑุฌุงุน ุงูุฌูุณุฉ]
    
    E --> G[AI Extraction ุจู GPT-4o-mini]
    F --> G
    
    G --> H[ุชุญููู ุงุณุชุฌุงุจุฉ AI]
    H --> I[ุฑุจุท ุฃุณูุงุก ุงูุนุฑุถ ุจุงูุญููู]
    I --> J[ุงูุชุญูู ูู ุตุญุฉ ุงูุจูุงูุงุช]
    J --> K[ุญุณุงุจ ุงูุญููู ุงููุงูุตุฉ]
    
    K --> L{ูู ุงูุญููู ููุชููุฉุ}
    L -->|ูุง| M[ุทูุจ ุงูุญููู ุงููุงูุตุฉ]
    L -->|ูุนู| N[ุชุตุฏูุฑ ูู Google Sheets]
    
    M --> O[ุฅุฑุณุงู ุฑุณุงูุฉ ููุนููู]
    N --> P[ุชุณุฌูู ูู ุณุฌู ุงูุชุตุฏูุฑ]
```

---

## ๐ **ููุฎุต ุงูุฅุญุตุงุฆูุงุช**

### **ุชูููุชุงุช ุงููุธุงู:**
- **ูุงูุฐุฉ ุงูุงูุชุธุงุฑ:** 8 ุซูุงูู ุฃู 5 ุฑุณุงุฆู
- **ุฒูู ุงููุนุงูุฌุฉ ุงููุชูุณุท:** 2-4 ุซูุงูู
- **ุฅุฌูุงูู ุงูุงุณุชุฌุงุจุฉ:** 10-12 ุซุงููุฉ ููุฑุฏูุฏ ุงููุนูุฏุฉ

### **ููุงุกุฉ Customer Profiles:**
- **ุชูููู ุงุณุชุฏุนุงุกุงุช AI:** 85% (ุจุฏูุงู ูู ูู ุฑุณุงูุฉุ ูู 5 ุฑุณุงุฆู)
- **ุชุญุณูู ุฌูุฏุฉ ุงูุณูุงู:** 400% (ูุนูููุงุช ุฃูุซุฑ ุฏูุฉ)
- **ุงุณุชููุงู ุงูููุงุฑุฏ:** 60% ุฃูู

### **ุฏูุฉ Data Collection:**
- **ูุนุฏู ุงุณุชุฎุฑุงุฌ ูุงุฌุญ:** 92%
- **ุฏุนู ุงููุบุงุช:** ุงูุนุฑุจูุฉ ูุงูุฅูุฌููุฒูุฉ
- **ุฃููุงุน ุงูุจูุงูุงุช:** 8 ุฃููุงุน ูุฎุชููุฉ

---

## ๐ฏ **ุงูุฎูุงุตุฉ**

ูุธุงู ConvGo ูุทุจู **ููุฌ ูุนุงูุฌุฉ ุฐูู** ูุฌูุน ุจูู:

1. **ุงูููุงุกุฉ:** ูุงูุฐุฉ 8 ุซูุงูู ูุฌูุน ุฑุณุงุฆู ูุชุนุฏุฏุฉ
2. **ุงูุฐูุงุก:** ูุนุงูุฌุฉ ูุฌูุนุฉ ุชุญุณู ููู ุงูุณูุงู  
3. **ุงูุชุญููู:** ุชุชุจุน ุชูุตููู ููููุงุช ุงูุนููุงุก
4. **ุงูุฃุชูุชุฉ:** ุฌูุน ูุชุตุฏูุฑ ุงูุจูุงูุงุช ุชููุงุฆูุงู
5. **ุงููุงุจููุฉ ููุชูุณุน:** ูุธุงู Redis ูููุนุงูุฌุฉ ุงููุชูุงุฒูุฉ

ูุฐุง ุงูุชุตููู ูุถูู **ุชุฌุฑุจุฉ ุนููู ูุชููุฒุฉ** ูุน **ููุงุกุฉ ุชุดุบูููุฉ ุนุงููุฉ** ูุงุณุชุฎุฏุงู **ุฃูุซู ููููุงุฑุฏ**.

---

*ุชู ุฅูุดุงุก ูุฐุง ุงูุชูุฑูุฑ ุจุชุงุฑูุฎ 2024-09-26*  
*ูุบุทู ุงูุชุฏูู ุงููุงูู ููุฑุณุงุฆู ูู ุงูุงุณุชูุจุงู ุญุชู ุงูุงุณุชุฌุงุจุฉ*